From 18f62c746698a58f6c0593876818637748f51b68 Mon Sep 17 00:00:00 2001
From: Brian Bockelman <bbockelman@morgridge.org>
Date: Thu, 16 Dec 2021 11:14:58 -0600
Subject: [PATCH 02/17] Provide an example use of the token subject.

(cherry picked from commit 93ed3bf9608a07b6d593aa8564155763e4c25e64)
---
 src/XrdThrottle/XrdThrottleFile.cc | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/xrootd/src/XrdThrottle/XrdThrottleFile.cc b/xrootd/src/XrdThrottle/XrdThrottleFile.cc
index 27d4d1a83..89213faab 100644
--- a/xrootd/src/XrdThrottle/XrdThrottleFile.cc
+++ b/xrootd/src/XrdThrottle/XrdThrottleFile.cc
@@ -1,6 +1,7 @@
 
 #include "XrdSfs/XrdSfsAio.hh"
 #include "XrdSec/XrdSecEntity.hh"
+#include "XrdSec/XrdSecEntityAttr.hh"
 
 #include "XrdThrottle.hh"
 
@@ -47,7 +48,15 @@ File::open(const char                *fileName,
            const XrdSecEntity        *client,
            const char                *opaque)
 {
-   m_uid = XrdThrottleManager::GetUid(client->name);
+   // Try various potential "names" associated with the request, from the most
+   // specific to most generic.
+   std::string unique_name;
+   if (client->eaAPI && client->eaAPI->Get("token.subject", unique_name)) {
+       if (client->vorg) unique_name += client->vorg;
+   } else if (client->eaAPI) {
+       client->eaAPI->Get("request.name", unique_name);
+   }
+   m_uid = XrdThrottleManager::GetUid(unique_name.empty() ? client->name : unique_name.c_str());
    m_throttle.PrepLoadShed(opaque, m_loadshed);
    return m_sfs->open(fileName, openMode, createMode, client, opaque);
 }
-- 
2.25.1

